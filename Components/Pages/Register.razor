@page "/register"
@using Microsoft.EntityFrameworkCore
@using Blazor_Board.Data
@using Blazor_Board.Models
@inject ApplicationDbContext _context
@inject NavigationManager Navigation

<PageTitle>회원가입</PageTitle>

<div class="max-w-md mx-auto mt-10">
    <div class="bg-white p-8 rounded-lg shadow-md">
        <h3 class="text-2xl font-bold mb-6 text-center">회원가입</h3>

        <EditForm Model="@newUser" OnValidSubmit="HandleRegister">
            <DataAnnotationsValidator />

            <div class="mb-4">
                <label for="username" class="block mb-2 text-sm font-medium text-gray-900">아이디</label>
                <InputText id="username" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" @bind-Value="newUser.Username" />
                <ValidationMessage For="@(() => newUser.Username)" />
            </div>
            <div class="mb-4">
                <label for="name" class="block mb-2 text-sm font-medium text-gray-900">이름</label>
                <InputText id="name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" @bind-Value="newUser.Name" />
                <ValidationMessage For="@(() => newUser.Name)" />
            </div>
            <div class="mb-6">
                <label for="password" class="block mb-2 text-sm font-medium text-gray-900">비밀번호</label>
                <InputText id="password" type="password" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" @bind-Value="newUser.Password" />
                <ValidationMessage For="@(() => newUser.Password)" />
            </div>

            <button type="submit" class="w-full text-white bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                가입하기
            </button>
        </EditForm>
    </div>
</div>


@code {
    private User newUser = new();
    private string errorMessage = string.Empty;

    private async Task HandleRegister()
    {
        // 이미 존재하는 아이디인지 확인
        var existingUser = await _context.Users.FirstOrDefaultAsync(u => u.Username == newUser.Username);

        if (existingUser != null)
        {
            // 간단한 에러 메시지 처리 (나중에 더 개선할 수 있습니다)
            errorMessage = "이미 사용 중인 아이디입니다.";
            return;
        }

        // 새 사용자 추가
        _context.Users.Add(newUser);
        await _context.SaveChangesAsync();

        // 로그인 페이지로 이동 (다음 단계에서 만들 예정)
        Navigation.NavigateTo("/login");
    }
}