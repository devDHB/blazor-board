@page "/login"
@using Microsoft.EntityFrameworkCore
@using Blazor_Board.Data
@using Blazor_Board.Models
@using Blazor_Board.Services;
@inject ApplicationDbContext _context
@inject NavigationManager Navigation
@inject UserSession UserSession;

<PageTitle>로그인</PageTitle>

<div class="max-w-md mx-auto mt-10">
    <div class="bg-white p-8 rounded-lg shadow-md">
        <h3 class="text-2xl font-bold mb-6 text-center">로그인</h3>

        <EditForm Model="@loginModel" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                    <span class="block sm:inline">@errorMessage</span>
                </div>
            }

            <div class="mb-4">
                <label for="username" class="block mb-2 text-sm font-medium text-gray-900">아이디</label>
                <InputText id="username" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" @bind-Value="loginModel.Username" />
            </div>
            <div class="mb-6">
                <label for="password" class="block mb-2 text-sm font-medium text-gray-900">비밀번호</label>
                <InputText id="password" type="password" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" @bind-Value="loginModel.Password" />
            </div>

            <button type="submit" class="w-full text-white bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                로그인
            </button>
        </EditForm>
    </div>
</div>

@code {
    // 로그인 폼 전용 모델 클래스
    public class LoginModel
    {
        public string Username { get; set; } = "";
        public string Password { get; set; } = "";
    }

    private LoginModel loginModel = new();
    private string errorMessage = string.Empty;

    private async Task HandleLogin()
    {
        // 1. DB에서 아이디로 사용자 찾기
        var user = await _context.Users
            .FirstOrDefaultAsync(u => u.Username == loginModel.Username);

        // 2. 사용자가 있고, 비밀번호가 일치하는지 확인
        if (user != null && user.Password == loginModel.Password)
        {
            // 로그인 성공!
            // (지금은 단순히 메인 페이지로 이동하지만, 나중에 실제 로그인 상태 관리 로직 추가)
            await UserSession.Login(user); // 세션 서비스에 사용자 정보 저장
            Navigation.NavigateTo("/");
        }
        else
        {
            // 로그인 실패
            errorMessage = "아이디 또는 비밀번호가 올바르지 않습니다.";
        }
    }
}